<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Planner | Command Center</title>
    <!-- ADDED: Favicon matching the dashboard icon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect width='7' height='9' x='3' y='3' rx='1'/><rect width='7' height='5' x='14' y='3' rx='1'/><rect width='7' height='9' x='14' y='12' rx='1'/><rect width='7' height='5' x='3' y='16' rx='1'/></svg>">
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- ADDED: ICS Parser Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.5.0/ical.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #6366f1;
            --brand-bg: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(226, 232, 240, 0.8);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--brand-bg);
            color: #1e293b;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* IMPROVED: APPEARANCE & INTERFACE STYLES (ENHANCED GLASSMORPHISM) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .widget-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 2.5rem;
            border: 1px solid #eef2f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.01), 0 2px 4px -1px rgba(0, 0, 0, 0.01);
        }

        .widget-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 30px 40px -10px rgba(0, 0, 0, 0.05);
            border-color: var(--brand-primary);
        }

        /* Sidebar State Improvement */
        .nav-active {
            background: linear-gradient(90deg, #eef2ff 0%, #ffffff 100%);
            color: #4f46e5 !important;
            font-weight: 800 !important;
            border-right: 5px solid #4f46e5;
        }

        /* Modern Typography Presets */
        .heading-hero {
            font-weight: 800;
            letter-spacing: -0.04em;
        }

        /* Timer Badge */
        .timer-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 1px solid #e2e8f0;
        }

        /* ==========================================================================
           THEME ENGINE STYLES (PRESERVED)
           ========================================================================== */

        body.theme-dark {
            --brand-bg: #0f172a;
            background-color: #0f172a;
            color: #f1f5f9;
        }
        body.theme-dark aside, 
        body.theme-dark header, 
        body.theme-dark .bg-white, 
        body.theme-dark .widget-card,
        body.theme-dark .calendar-cell {
            background-color: #1e293b !important;
            color: #f1f5f9;
            border-color: #334155 !important;
        }
        body.theme-dark .text-slate-800, 
        body.theme-dark .text-slate-700, 
        body.theme-dark .text-slate-600 {
            color: #cbd5e1 !important;
        }
        body.theme-dark .bg-slate-50, 
        body.theme-dark .bg-slate-100, 
        body.theme-dark .calendar-day-header {
            background-color: #0f172a !important;
            color: #94a3b8;
        }

        body.theme-colorful {
            --brand-primary: #d946ef;
            --brand-bg: #fdf4ff;
            background-color: #fdf4ff;
        }
        body.theme-colorful .bg-indigo-600 { background-color: #d946ef !important; }
        body.theme-colorful .text-indigo-600 { color: #d946ef !important; }

        body.theme-party {
            animation: party-bg-cycle 10s infinite alternate;
        }
        @keyframes party-bg-cycle {
            0% { background-color: #fee2e2; }
            33% { background-color: #e0e7ff; }
            66% { background-color: #dcfce7; }
            100% { background-color: #fef9c3; }
        }

        /* ==========================================================================
           NOTIFICATION SYSTEM STYLES (PRESERVED)
           ========================================================================== */
        
        #nexus-notification-hub {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .notification-toast {
            pointer-events: auto;
            min-width: 340px;
            background: white;
            padding: 24px;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border-left: 8px solid;
            display: flex;
            flex-direction: column;
            animation: toast-slide-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes toast-slide-in {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-toast.dismissing {
            animation: toast-slide-out 0.3s forwards;
        }

        @keyframes toast-slide-out {
            to { transform: translateX(120%); opacity: 0; }
        }

        /* ==========================================================================
           EXISTING CORE STYLES (PRESERVED)
           ========================================================================== */

        .widget-ghost {
            opacity: 0.3;
            background: #e2e8f0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
        }

        .calendar-scroll-area {
            overflow-y: auto;
            flex: 1;
            max-height: calc(100vh - 320px);
        }

        .calendar-day-header {
            position: sticky;
            top: 0;
            z-index: 5; 
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .calendar-cell {
            min-height: 120px;
            background: white;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px;
            transition: background 0.2s;
        }

        .calendar-cell:hover {
            background: #fdfdfd;
        }

        .calendar-cell.other-month {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .calendar-cell.today {
            background: #f0f9ff;
        }

        .calendar-cell.today .day-label {
            background: #2563eb;
            color: white;
            border-radius: 999px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center; justify-content: center;
        }

        .event-chip {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
            cursor: pointer;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .btn-tab-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 800;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .btn-tab-action:hover {
            background: #f8fafc;
            border-color: var(--brand-primary);
            color: var(--brand-primary);
            transform: translateY(-1px);
        }

        /* Modal Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
        .zoom-in { animation: zoomIn 0.2s ease-out; }

        .prio-3 { border-left: 8px solid #ef4444 !important; } 
        .prio-2 { border-left: 8px solid #f59e0b !important; } 
        .prio-1 { border-left: 8px solid #3b82f6 !important; }

        header {
            position: sticky;
            top: 0;
            z-index: 40 !important;
        }
    </style>
</head>
<body class="overflow-hidden theme-light">

    <!-- ADDED: Timer Sound -->
    <audio id="timer-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- UI container for notification logic -->
    <div id="nexus-notification-hub"></div>

    <div id="app" class="flex h-screen w-full">
        <!-- Main Sidebar -->
        <aside id="sidebar" class="w-72 bg-white border-r flex flex-col shrink-0 z-50 glass-panel">
            <div class="p-8 flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-100 rotate-3 transition-transform hover:rotate-0">
                    <i data-lucide="layout-dashboard" class="w-7 h-7"></i>
                </div>
                <h1 class="text-2xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">Nexus</h1>
            </div>

            <nav id="nav-container" class="flex-1 px-4 space-y-1 overflow-y-auto hide-scrollbar">
                <!-- Nav items generated dynamically -->
            </nav>

            <div class="p-6 border-t mt-auto">
                <button onclick="router.navigate('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i> Settings
                </button>
                <div class="mt-4 px-4 py-4 bg-slate-50 rounded-2xl border border-slate-100 italic">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Local Privacy</p>
                    <p class="text-[11px] text-slate-500 font-bold mt-1 leading-tight">Your data never leaves this device.</p>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
            <header class="h-20 bg-white/80 backdrop-blur-md border-b px-10 flex items-center justify-between shrink-0 z-40">
                <div class="flex items-center gap-8 flex-1 min-w-0">
                    <div class="flex flex-col shrink-0">
                        <div class="flex items-center">
                            <h2 id="view-title" class="text-2xl font-black text-slate-800 whitespace-nowrap tracking-tight">Command Center</h2>
                            <div id="tab-action-container"></div>
                        </div>
                        <p id="view-subtitle" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5"></p>
                    </div>

                    <!-- Global Search Input -->
                    <div class="relative w-full max-w-md hidden lg:block">
                        <i data-lucide="search" class="absolute left-4 top-3 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="global-search" oninput="logic.search(this.value)" placeholder="Find things quickly..." class="w-full bg-slate-100 border-none rounded-2xl py-2.5 pl-11 pr-4 text-sm focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all">
                    </div>
                </div>

                <div class="flex items-center gap-6 shrink-0 ml-4">
                    <div id="clock-display" class="text-right hidden md:block">
                        <div id="clock-time" class="text-sm font-black text-slate-800 tracking-tighter"></div>
                        <div id="clock-date" class="text-[10px] font-black text-slate-400 uppercase tracking-widest"></div>
                    </div>
                    <button onclick="ui.modal.openQuickAdd()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-sm font-black shadow-lg shadow-indigo-100 hover:scale-105 active:scale-95 transition-all flex items-center gap-2 whitespace-nowrap">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Entry
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto scroll-smooth flex flex-col">
                <div id="viewport" class="flex-1 p-10">
                    <!-- Data views injected here -->
                </div>

                <footer class="p-10 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest border-t bg-white/50 backdrop-blur-sm">
                    <a href="https://nexusplanner.github.io" class="hover:text-indigo-600 transition-colors">Nexus Planner</a> © 2026 by <a href="https://derrickrichard.github.io/profile/" class="hover:text-indigo-600 transition-colors">Derrick Richard</a> is licensed under <a href="https://creativecommons.org/licenses/by-nd/4.0/" class="hover:text-indigo-600 transition-colors">CC BY-ND 4.0</a><img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;"><img src="https://mirrors.creativecommons.org/presskit/icons/nd.svg" alt="" style="max-width: 1em;max-height:1em;margin-left: .2em; display: inline-block; vertical-align: middle;">
                </footer>
            </div>
        </main>
    </div>

    <!-- Universal Modal System -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modal-container" class="bg-white rounded-[2.5rem] shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in border border-white/20">
            <div class="p-10 border-b flex justify-between items-center bg-white sticky top-0">
                <div class="flex flex-col">
                    <h3 id="modal-title" class="text-3xl font-black text-slate-900 leading-none">Quick Add</h3>
                    <p id="modal-subtitle" class="text-xs text-slate-400 font-black uppercase tracking-widest mt-2"></p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="modal-actions"></div>
                    <button onclick="ui.modal.close()" class="p-4 hover:bg-slate-100 rounded-full transition-colors text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div id="modal-body" class="p-10 overflow-y-auto bg-slate-50/20">
            </div>
        </div>
    </div>

    <script>
        /** 
         * 1. DATABASE LAYER (PRESERVED)
         */
        const db = new Dexie("PlannerCompleteStorage");
        
        db.version(2).stores({
            tasks: '++id, title, status, priority, dueDate, section, projectId, classId, isRecurring, description',
            projects: '++id, name, status, progress, deadline, description',
            school: '++id, className, instructor, semester',
            assignments: '++id, title, classId, dueDate, status, weight',
            events: '++id, title, start, end, location, category, description',
            habits: '++id, name, streak, logs, goal',
            extra: '++id, name, role, hours',
            settings: 'key, value',
            backups: '++id, timestamp',
            reminders: '++id, title, time, priority, color, dismissed' 
        });

        /**
         * 2. STATE & CONFIGURATION (PRESERVED)
         */
        const defaultConfig = {
            dashboardMode: 'command',
            theme: 'light',
            features: {
                tasks: true,
                projects: true,
                school: true,
                habits: true,
                events: true,
                extra: true
            },
            automation: {
                autoCarryover: true,
                smartSort: true
            }
        };

        const localConfig = JSON.parse(localStorage.getItem('app_config')) || {};
        const state = {
            currentView: 'dashboard',
            currentCalendarDate: new Date(),
            dashboardLayout: JSON.parse(localStorage.getItem('dashboard_layout')) || ['focus', 'tasks', 'schedule', 'habits', 'projects', 'school', 'extra'],
            searchQuery: '',
            /* UPDATED: COMPREHENSIVE TIMER STATE */
            pomodoro: { time: 1500, active: false, interval: null, totalTime: 1500 },
            config: {
                ...defaultConfig,
                ...localConfig,
                features: { ...defaultConfig.features, ...(localConfig.features || {}) },
                automation: { ...defaultConfig.automation, ...(localConfig.automation || {}) }
            }
        };

        const FEATURE_META = {
            dashboard: { id: 'dashboard', label: 'Command Center', icon: 'home' },
            tasks: { id: 'tasks', label: 'Checklist', icon: 'check-circle-2' },
            assignment: { id: 'assignment', label: 'Education', icon: 'book-text' },
            projects: { id: 'projects', label: 'Growth', icon: 'folder-kanban' },
            school: { id: 'school', label: 'Curriculum', icon: 'graduation-cap' },
            habits: { id: 'habits', label: 'Recurrence', icon: 'zap' },
            events: { id: 'events', label: 'Temporal', icon: 'calendar-days' },
            extra: { id: 'extra', label: 'Extras', icon: 'star' }
        };

        const PRIORITY_LABELS = { "1": "Low", "2": "Medium", "3": "High" };

        /**
         * 3. UI CONTROLLER (PRESERVED)
         */
        const ui = {
            init: async () => {
                logic.applyTheme(); 
                ui.refreshNavigation();
                ui.updateClock();
                setInterval(ui.updateClock, 1000);
                setInterval(logic.checkActiveReminders, 12000); 
                await automation.runner();
                router.load('dashboard');
            },

            refreshNavigation: () => {
                const nav = document.getElementById('nav-container');
                let html = `
                    <button onclick="router.navigate('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-4 px-4 py-4 text-sm font-bold rounded-2xl transition-all">
                        <i data-lucide="home" class="w-5 h-5"></i> Dashboard
                    </button>
                    <div class="pt-8 pb-3 px-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Workflow Modules</div>
                `;

                Object.keys(state.config.features).forEach(key => {
                    if (state.config.features[key]) {
                        const meta = FEATURE_META[key];
                        html += `
                            <button onclick="router.navigate('${key}')" id="nav-${key}" class="w-full flex items-center gap-4 px-4 py-4 text-sm font-bold text-slate-500 hover:bg-white rounded-2xl transition-all">
                                <i data-lucide="${meta.icon}" class="w-5 h-5"></i> ${meta.label}
                            </button>
                        `;
                    }
                });

                nav.innerHTML = html;
                lucide.createIcons();
            },

            updateClock: () => {
                const now = new Date();
                const clockTime = document.getElementById('clock-time');
                const clockDate = document.getElementById('clock-date');
                if (!clockTime) return;
                clockTime.innerText = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                clockDate.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            },

            modal: {
                open: (title, subtitle, bodyHtml, actionsHtml = '') => {
                    document.getElementById('modal-title').innerText = title;
                    document.getElementById('modal-subtitle').innerText = subtitle;
                    document.getElementById('modal-body').innerHTML = bodyHtml;
                    document.getElementById('modal-actions').innerHTML = actionsHtml;
                    document.getElementById('modal-overlay').classList.remove('hidden');
                    lucide.createIcons();
                },
                close: () => {
                    document.getElementById('modal-overlay').classList.add('hidden');
                },
                openQuickAdd: () => {
                    const enabled = Object.keys(state.config.features).filter(f => state.config.features[f]);
                    let html = `<div class="grid grid-cols-2 gap-6">`;
                    enabled.forEach(key => {
                        html += `
                            <button onclick="ui.modal.renderForm('${key}')" class="flex flex-col items-start p-8 bg-white border border-slate-100 rounded-[2.5rem] hover:border-indigo-500 hover:bg-indigo-50 transition-all group">
                                <i data-lucide="${FEATURE_META[key].icon}" class="w-8 h-8 text-slate-200 group-hover:text-indigo-600 mb-6 transition-colors font-black"></i>
                                <span class="font-black text-slate-800 text-lg">${FEATURE_META[key].label}</span>
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Manifest New</span>
                            </button>
                        `;
                    });
                    html += `</div>`;
                    ui.modal.open("New Entry", "Choose what you want to add to your workspace", html);
                },
                renderForm: async (key, editId = null) => {
                    const editData = editId ? await db[key==='assignment'?'tasks':key].get(editId) : null;
                    let formHtml = `<form onsubmit="logic.handleForm(event, '${key === 'assignment' ? 'tasks' : key}', ${editId})" class="space-y-6">`;
                    switch(key) {
                        case 'assignment':
                        case 'tasks':
                            const schoolClasses = await db.school.toArray();
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Title</label><input name="title" required value="${editData?.title || ''}" class="w-full p-5 bg-white border border-slate-100 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all" placeholder="Enter Task Name"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Priority</label>
                                        <select name="priority" class="w-full p-5 bg-white border border-slate-100 rounded-3xl outline-none">
                                            <option value="1" ${editData?.priority==1?'selected':''}>Low</option>
                                            <option value="2" ${!editData||editData.priority==2?'selected':''}>Medium</option>
                                            <option value="3" ${editData?.priority==3?'selected':''}>High</option>
                                        </select>
                                    </div>
                                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Due Date</label><input type="date" name="dueDate" class="w-full p-5 bg-white border border-slate-100 rounded-3xl" value="${editData?.dueDate || new Date().toISOString().split('T')[0]}"></div>
                                </div>
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Description</label><textarea name="description" class="w-full p-5 bg-white border border-slate-100 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-500/10 h-32" placeholder="Add more details...">${editData?.description || ''}</textarea></div>
                                <div>
                                    <label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Link Education</label>
                                    <select name="classId" class="w-full p-5 border border-slate-100 rounded-3xl" ${key === 'assignment' ? 'required' : ''}>
                                        <option value="">${key === 'assignment' ? '-- Select Course --' : 'No Class'}</option>
                                        ${schoolClasses.map(c => `<option value="${c.id}" ${editData?.classId==c.id?'selected':''}>${c.className}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                            break;
                        case 'events':
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Event Description</label><input name="title" required value="${editData?.title || ''}" class="w-full p-5 bg-white border border-slate-100 rounded-3xl outline-none"></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Starts</label><input type="datetime-local" name="start" required class="w-full p-5 border rounded-3xl" value="${editData?.start || new Date().toISOString().slice(0, 16)}"></div>
                                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Ends</label><input type="datetime-local" name="end" required class="w-full p-5 border rounded-3xl" value="${editData?.end || new Date().toISOString().slice(0, 16)}"></div>
                                </div>
                            `;
                            break;
                        case 'projects':
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Project</label><input name="name" required value="${editData?.name || ''}" class="w-full p-5 bg-white border rounded-3xl outline-none"></div>
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Deadline</label><input type="date" name="deadline" class="w-full p-5 border rounded-3xl" value="${editData?.deadline || new Date().toISOString().split('T')[0]}"></div>
                            `;
                            break;
                        case 'habits':
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Daily Action</label><input name="name" required value="${editData?.name || ''}" placeholder="e.g. Meditate for 10m" class="w-full p-5 border rounded-3xl outline-none"></div>
                            `;
                            break;
                        case 'school':
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Class Label</label><input name="className" required value="${editData?.className || ''}" placeholder="e.g. Physics 101" class="w-full p-5 border rounded-3xl outline-none"></div>
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Instructor</label><input name="instructor" value="${editData?.instructor || ''}" class="w-full p-5 border rounded-3xl outline-none"></div>
                            `;
                            break;
                        case 'extra':
                            formHtml += `
                                <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Activity Title</label><input name="name" required value="${editData?.name || ''}" class="w-full p-5 border rounded-3xl outline-none"></div>
                            `;
                            break;
                    }
                    formHtml += `<button type="submit" class="w-full py-6 bg-indigo-600 text-white font-black rounded-3xl shadow-xl shadow-indigo-100 mt-4 hover:bg-slate-900 transition-all">${editId ? 'Commit Changes' : 'Manifest Now'}</button></form>`;
                    document.getElementById('modal-body').innerHTML = formHtml;
                    ui.modal.open(`${editId?'Edit':'Create'} ${key}`, "Please specify the manifest details", formHtml);
                }
            }
        };

        /**
         * 4. ROUTER & VIEWS (PRESERVED)
         */
        const router = {
            navigate: (view) => {
                state.currentView = view;
                router.load(view);
                ui.refreshNavigation();
                const btn = document.getElementById(`nav-${view}`);
                if (btn) {
                    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
                    btn.classList.add('nav-active');
                }
            },

            load: async (view) => {
                const viewport = document.getElementById('viewport');
                const title = document.getElementById('view-title');
                const actionBtn = document.getElementById('tab-action-container');
                
                title.innerText = FEATURE_META[view]?.label || 'Settings';

                if(view !== 'dashboard' && view !== 'settings') {
                    if (view === 'events') {
                        actionBtn.innerHTML = `
                            <button onclick="ui.modal.renderForm('events')" class="btn-tab-action">
                                <i data-lucide="plus-circle"></i> Add
                            </button>
                            <button onclick="document.getElementById('ics-upload').click()" class="btn-tab-action">
                                <i data-lucide="file-up"></i> Sync ICS
                            </button>
                            <input type="file" id="ics-upload" class="hidden" accept=".ics" multiple onchange="logic.importIcs(this)">
                        `;
                    } else {
                        actionBtn.innerHTML = `
                            <button onclick="ui.modal.renderForm('${view}')" class="btn-tab-action">
                                <i data-lucide="plus-circle"></i> Add New
                            </button>
                        `;
                    }
                } else { actionBtn.innerHTML = ''; }

                viewport.innerHTML = `<div class="flex items-center justify-center py-20"><div class="animate-spin h-10 w-10 border-[5px] border-indigo-600 border-t-transparent rounded-full"></div></div>`;
                switch(view) {
                    case 'dashboard': await renderers.dashboard(viewport); break;
                    case 'tasks': await renderers.tasks(viewport); break;
                    case 'projects': await renderers.projects(viewport); break;
                    case 'school': await renderers.school(viewport); break;
                    case 'habits': await renderers.habits(viewport); break;
                    case 'events': await renderers.events(viewport); break;
                    case 'extra': await renderers.extra(viewport); break;
                    case 'settings': await renderers.settings(viewport); break;
                }
                lucide.createIcons();
            }
        };

        /**
         * 5. VIEW RENDERERS (PRESERVED)
         */
        const renderers = {
            dashboard: async (target) => {
                target.innerHTML = `
                    <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                        ${state.dashboardLayout.map(wId => `
                            <div data-id="${wId}" class="widget-card bg-white border border-slate-100 rounded-[2.5rem] shadow-sm flex flex-col group min-h-[380px]">
                                <div class="widget-header px-10 py-6 border-b flex justify-between items-center cursor-move">
                                    <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.25em]">${wId}</h3>
                                    <i data-lucide="grip-vertical" class="w-4 h-4 text-slate-200 group-hover:text-indigo-400 transition-colors"></i>
                                </div>
                                <div id="widget-content-${wId}" class="p-10 flex-1 overflow-y-auto hide-scrollbar"></div>
                            </div>
                        `).join('')}
                    </div>
                `;
                new Sortable(document.getElementById('widget-grid'), {
                    animation: 250, handle: '.widget-header', ghostClass: 'widget-ghost',
                    onEnd: (evt) => {
                        const newOrder = Array.from(evt.to.children).map(el => el.dataset.id);
                        localStorage.setItem('dashboard_layout', JSON.stringify(newOrder));
                    }
                });
                const loaders = {
                    focus: () => {
                        /* UPDATED: DURATION SELECTOR UI FOR TIMER */
                        document.getElementById('widget-content-focus').innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full gap-6">
                                <div class="relative flex items-center justify-center">
                                    <div id="pomo-timer" class="text-7xl font-black text-slate-800 tracking-tighter transition-all">${Math.floor(state.pomodoro.time/60)}:${(state.pomodoro.time%60).toString().padStart(2, '0')}</div>
                                </div>
                                <div class="timer-badge">Session Length: ${Math.floor(state.pomodoro.totalTime/60)}m</div>
                                <div class="flex gap-4 w-full">
                                    <button onclick="logic.togglePomodoro()" class="flex-1 py-5 ${state.pomodoro.active?'bg-slate-100 text-slate-600':'bg-indigo-600 text-white shadow-xl'} text-xs font-black uppercase tracking-widest rounded-2xl transition-all active:scale-95">
                                        ${state.pomodoro.active?'Halt':'Focus'}
                                    </button>
                                    <button title="Change Duration" onclick="logic.showTimerSettings()" class="px-5 bg-slate-50 border border-slate-100 rounded-2xl text-slate-400 hover:text-indigo-600 transition-all"><i data-lucide="timer" class="w-6 h-6"></i></button>
                                </div>
                            </div>
                        `;
                    },
                    tasks: async () => {
                        const tasks = await db.tasks.where('status').notEqual('done').limit(5).toArray();
                        document.getElementById('widget-content-tasks').innerHTML = tasks.length ? `<div class="space-y-4">${tasks.map(t => `<div onclick="logic.showDetails('tasks', ${t.id})" class="flex items-center gap-3 p-3 hover:bg-slate-50 border border-transparent hover:border-slate-100 rounded-2xl cursor-pointer transition-all"><div class="w-2.5 h-2.5 rounded-full ${t.priority==3?'bg-red-500':t.priority==2?'bg-amber-400':'bg-blue-400'}"></div> <span class="text-sm font-bold text-slate-700 truncate">${t.title}</span></div>`).join('')}</div>` : `<div class="p-10 text-center text-slate-300 italic text-sm">Clear Horizon.</div>`;
                    },
                    habits: async () => {
                        const habits = await db.habits.toArray();
                        document.getElementById('widget-content-habits').innerHTML = habits.length ? `<div class="space-y-6">${habits.map(h => `<div><div class="flex justify-between text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3"><span>${h.name}</span><span class="text-indigo-600">${h.streak}d streak</span></div><div class="w-full bg-slate-50 h-2 rounded-full overflow-hidden border border-slate-200"><div class="bg-indigo-600 h-full transition-all duration-1000" style="width: ${Math.min(h.streak * 10, 100)}%"></div></div></div>`).join('')}</div>` : `<div class="p-10 text-center text-slate-300 italic text-sm">No recurrence set.</div>`;
                    },
                    schedule: async () => {
                        const today = new Date().toISOString().split('T')[0];
                        const dayEvents = await db.events.where('start').startsWith(today).toArray();
                        document.getElementById('widget-content-schedule').innerHTML = dayEvents.length ? `<div class="space-y-4">${dayEvents.map(e => `<div class="flex gap-4 items-start cursor-pointer hover:translate-x-1 transition-all" onclick="logic.showDetails('events', ${e.id})"><div class="w-1 text-[10px] font-black text-slate-300 leading-tight pt-1 capitalize">${(e.start.split('T')[1] || "00:00").slice(0,5)}</div><div class="flex-1 bg-white border border-slate-100 p-4 rounded-3xl group hover:border-indigo-400/30 transition-all shadow-sm"><p class="text-xs font-black text-slate-800">${e.title}</p></div></div>`).join('')}</div>` : `<div class="p-10 text-center text-slate-300 italic text-sm">Open Temporal Grid.</div>`;
                    },
                    projects: async () => {
                        const projs = await db.projects.toArray();
                        document.getElementById('widget-content-projects').innerHTML = projs.length ? `<div class="space-y-4">${projs.map(p => `<div onclick="logic.showDetails('projects', ${p.id})" class="p-5 bg-slate-50 border border-slate-100 rounded-[1.5rem] flex justify-between items-center cursor-pointer hover:bg-white transition-all"><span class="text-xs font-black truncate text-slate-700">${p.name}</span> <span class="text-[10px] font-black text-indigo-700 bg-indigo-50 px-2 py-1 rounded-lg">${p.progress}%</span></div>`).join('')}</div>` : '<div class="p-10 text-center text-slate-300 italic text-sm">No active builds.</div>';
                    },
                    school: async () => {
                        const classes = await db.school.limit(3).toArray();
                        document.getElementById('widget-content-school').innerHTML = classes.length ? `<div class="space-y-4">${classes.map(c => `<div class="p-5 bg-indigo-50 border border-indigo-100/50 rounded-3xl text-sm font-black text-indigo-700 flex items-center gap-3"><i data-lucide="graduation-cap" class="w-4 h-4 text-indigo-400"></i> ${c.className}</div>`).join('')}</div>` : '<div class="p-10 text-center text-slate-300 italic text-sm">No modules.</div>';
                    },
                    extra: async () => {
                        const extras = await db.extra.limit(5).toArray();
                        document.getElementById('widget-content-extra').innerHTML = extras.length ? `<div class="space-y-4">${extras.map(e => `<div class="p-5 bg-white border border-slate-100 rounded-3xl text-xs font-black text-slate-700 shadow-sm">${e.name}</div>`).join('')}</div>` : `<div class="p-10 text-center text-slate-300 italic text-sm">No extras.</div>`;
                    }
                };
                Object.keys(loaders).forEach(k => {
                    if(document.getElementById(`widget-content-${k}`)) loaders[k]();
                });
                lucide.createIcons();
            },

            events: async (target) => {
                const year = state.currentCalendarDate.getFullYear();
                const month = state.currentCalendarDate.getMonth();
                const monthName = state.currentCalendarDate.toLocaleString('default', { month: 'long' });
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const events = await db.events.toArray();
                target.innerHTML = `
                    <div class="bg-white rounded-[3rem] shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                        <div class="p-10 border-b flex justify-between items-center bg-white sticky top-0 z-30">
                            <div class="flex items-center gap-6">
                                <button onclick="renderers.changeMonth(-1)" class="p-3 hover:bg-slate-50 rounded-2xl transition-all"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                                <h3 class="text-3xl font-black">${monthName} <span class="text-indigo-600 font-black">${year}</span></h3>
                                <button onclick="renderers.changeMonth(1)" class="p-3 hover:bg-slate-50 rounded-2xl transition-all"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                            </div>
                            <button onclick="state.currentCalendarDate = new Date(); router.load('events')" class="text-[10px] font-black uppercase tracking-widest text-indigo-600 hover:bg-indigo-50 px-6 py-3 rounded-2xl transition-all">Jump to Today</button>
                        </div>
                        <div class="calendar-scroll-area hide-scrollbar">
                            <div class="calendar-grid bg-slate-100">
                                ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(h => `<div class="calendar-day-header p-5 text-center text-[10px] font-black text-slate-400 uppercase tracking-widest border-r border-slate-100">${h}</div>`).join('')}
                                ${renderers.calculateCalendarDays(year, month, firstDay, daysInMonth, events)}
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            calculateCalendarDays: (year, month, firstDay, daysInMonth, events) => {
                let html = '';
                const today = new Date().toISOString().split('T')[0];
                const prevMonthDays = new Date(year, month, 0).getDate();
                for (let i = firstDay; i > 0; i--) html += `<div class="calendar-cell other-month flex flex-col"><span class="text-xs font-bold opacity-30">${prevMonthDays - i + 1}</span></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateId = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEvents = events.filter(e => e.start.startsWith(dateId));
                    const isToday = dateId === today;
                    html += `<div class="calendar-cell ${isToday ? 'today' : ''} flex flex-col group p-3 hover:bg-indigo-50/20 transition-all border-r border-b border-slate-100"><div class="flex justify-between items-center mb-2"><span class="day-label text-sm font-black text-slate-700">${day}</span></div><div class="flex-1 space-y-1">${dayEvents.map(e => `<div class="text-[10px] font-black bg-indigo-600 text-white px-2 py-1 rounded shadow-sm truncate cursor-pointer hover:scale-105 active:scale-95 transition-all" onclick="logic.showDetails('events', ${e.id})">${e.title}</div>`).join('')}</div></div>`;
                }
                return html;
            },

            changeMonth: (offset) => { state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + offset); router.load('events'); },

            tasks: async (target) => {
                let tasks = await db.tasks.toArray();
                if (state.searchQuery) tasks = tasks.filter(t => t.title.toLowerCase().includes(state.searchQuery));
                const grouped = { pending: tasks.filter(t => t.status !== 'done'), completed: tasks.filter(t => t.status === 'done') };
                target.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-16 pb-20">
                        <section>
                            <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.25em] mb-10">Active Readiness</h3>
                            <div class="space-y-4">
                                ${grouped.pending.map(t => `<div class="bg-white p-7 rounded-[2.5rem] border border-slate-100 flex items-center justify-between group shadow-sm transition-all prio-${t.priority}"><div class="flex items-center gap-8"><input type="checkbox" onchange="logic.toggleTask(${t.id})" class="w-7 h-7 rounded-full border-slate-200 cursor-pointer"><div><p class="font-black text-slate-800 text-xl cursor-pointer hover:underline" onclick="logic.showDetails('tasks', ${t.id})">${t.title}</p><p class="text-[11px] font-black text-slate-400 mt-1 uppercase tracking-widest">${t.dueDate || 'Scheduling Pending'} • ${PRIORITY_LABELS[t.priority]} Mission</p></div></div><button onclick="logic.deleteData('tasks', ${t.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all p-3"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('') || `<div class="text-center py-20 bg-white rounded-[3rem] border border-dashed border-slate-200"><p class="text-slate-300 font-black uppercase tracking-widest text-xs">Clear Agenda Matrix.</p></div>`}
                            </div>
                        </section>
                        <section class="opacity-40 hover:opacity-100 transition-opacity">
                            <h3 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.25em] mb-10">Historical Cleared</h3>
                            <div class="space-y-3">
                                ${grouped.completed.map(t => `<div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-100 flex items-center gap-4"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i> <span class="text-sm font-bold text-slate-400 line-through cursor-pointer" onclick="logic.showDetails('tasks', ${t.id})">${t.title}</span></div>`).join('')}
                            </div>
                        </section>
                    </div>
                `; lucide.createIcons();
            },

            settings: async (target) => {
                target.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-16 pb-20">
                        <section>
                            <h3 class="text-[12px] font-black uppercase tracking-[0.3em] text-slate-400 mb-8 flex items-center gap-3"><i data-lucide="palette" class="w-5 h-5"></i> Atmosphere Selection</h3>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                                ${['light', 'dark', 'colorful', 'party'].map(t => `
                                    <button onclick="logic.setTheme('${t}')" class="p-6 bg-white border-2 rounded-[2.5rem] text-left transition-all hover:translate-y-[-4px] active:translate-y-0 ${state.config.theme === t ? 'border-indigo-600 shadow-xl shadow-indigo-100' : 'border-slate-50'}">
                                        <div class="w-full h-12 rounded-2xl mb-4 ${t === 'light' ? 'bg-slate-100' : t === 'dark' ? 'bg-slate-800' : t === 'colorful' ? 'bg-pink-100' : 'bg-gradient-to-tr from-yellow-200 to-indigo-200'}"></div>
                                        <span class="text-xs font-black capitalize text-slate-800">${t} Engine</span>
                                    </button>
                                `).join('')}
                            </div>
                        </section>

                        <section>
                            <h3 class="text-[12px] font-black uppercase tracking-[0.3em] text-slate-400 mb-8 flex items-center gap-3"><i data-lucide="bell" class="w-5 h-5"></i> Automated Schedules</h3>
                            <div id="active-reminders-list" class="space-y-4"></div>
                            <button onclick="logic.openNewReminderModal()" class="w-full py-6 bg-white border-2 border-dashed border-indigo-200 rounded-[2.5rem] font-black text-indigo-600 text-[10px] uppercase tracking-widest mt-6 hover:bg-slate-50 transition-all">+ Register New Schedule Rule</button>
                        </section>

                        <section><h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> System Function Modules</h3><div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 divide-y overflow-hidden">
                        ${Object.keys(state.config.features).map(key => `<div class="p-8 flex items-center justify-between hover:bg-slate-50 transition-colors"><div class="flex items-center gap-6"><div class="w-12 h-12 bg-white border border-slate-100 rounded-3xl flex items-center justify-center text-slate-400"><i data-lucide="${FEATURE_META[key].icon}" class="w-6 h-6"></i></div><div><p class="font-black text-slate-700 capitalize text-lg">${key}</p><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Active Component</p></div></div><button onclick="logic.toggleFeature('${key}')" class="w-16 h-9 rounded-full relative transition-all shadow-inner ${state.config.features[key] ? 'bg-indigo-600' : 'bg-slate-300'}"><div class="w-7 h-7 bg-white rounded-full absolute top-1 transition-all ${state.config.features[key] ? 'right-1' : 'left-1'}"></div></button></div>`).join('')}
                        </div></section>

                        <section><h3 class="text-sm font-black uppercase tracking-widest text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="database" class="w-4 h-4"></i> Localized Storage Integrity</h3><div class="grid grid-cols-2 gap-8"><button onclick="logic.exportData()" class="p-10 bg-slate-900 text-white rounded-[3rem] font-black flex flex-col items-center gap-6 hover:bg-indigo-600 transition-all font-black uppercase tracking-widest text-xs"><i data-lucide="download" class="w-8 h-8"></i><br>Export DB Backup</button><button onclick="logic.factoryReset()" class="p-10 bg-red-50 text-red-600 border border-red-100 rounded-[3rem] font-black flex flex-col items-center gap-6 hover:bg-red-500 hover:text-white transition-all font-black uppercase tracking-widest text-xs"><i data-lucide="trash-2" class="w-10 h-10"></i><br>Wipe Database</button></div></section>
                    </div>
                `;
                logic.refreshRemindersList(); lucide.createIcons();
            },

            projects: async (target) => {
                let projs = await db.projects.toArray(); if (state.searchQuery) projs = projs.filter(p => p.name.toLowerCase().includes(state.searchQuery));
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    ${projs.map(p => `<div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 transition-all hover:border-indigo-200 cursor-pointer" onclick="logic.showDetails('projects', ${p.id})"><h4 class="text-2xl font-black mb-8 text-slate-800 tracking-tight">${p.name}</h4><div class="mt-auto"><div class="flex justify-between text-[11px] font-black text-slate-400 uppercase mb-4 tracking-widest"><span>Execution Stage</span><span>${p.progress}%</span></div><div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden border border-slate-100"><div class="bg-indigo-600 h-full transition-all duration-1000" style="width: ${p.progress}%"></div></div><div class="flex gap-4 mt-10" onclick="event.stopPropagation()"><button onclick="logic.updateProjectProgress(${p.id}, 10)" class="flex-1 py-4 text-xs font-black bg-indigo-50 text-indigo-600 rounded-2xl border border-indigo-100 hover:bg-indigo-600 hover:text-white transition-all">+10% Inc</button><button onclick="logic.deleteData('projects', ${p.id})" class="p-4 text-red-500 hover:bg-red-50 rounded-2xl"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div></div>`).join('') || '<div class="col-span-full py-20 text-center opacity-30 font-black uppercase tracking-widest text-xs">No active builds.</div>'}
                </div>`; lucide.createIcons();
            },

            habits: async (target) => {
                const list = await db.habits.toArray();
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-10">${list.map(h => `<div class="bg-white p-10 rounded-[3.5rem] shadow-sm border border-slate-100 flex flex-col items-center text-center relative group">
                    <button onclick="logic.deleteData('habits', ${h.id})" class="absolute top-8 right-8 text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
                    <h4 class="font-black text-slate-800 text-xl mb-4 tracking-tight">${h.name}</h4>
                    <div class="text-6xl font-black text-indigo-600 mb-2">${h.streak}</div>
                    <p class="text-[11px] font-black uppercase text-slate-400 tracking-[0.3em] mb-10">Current Streak</p>
                    <div class="w-full flex gap-3"><button onclick="logic.incrementHabit(${h.id})" class="flex-1 py-5 bg-slate-900 text-white font-black text-xs uppercase tracking-widest rounded-[2rem] shadow-xl hover:scale-105 transition-all">Daily Log</button><button onclick="logic.resetHabit(${h.id})" class="p-5 bg-slate-50 border rounded-[2rem] text-slate-300 hover:text-orange-500 transition-all"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button></div>
                </div>`).join('') || '<div class="col-span-full py-20 text-center opacity-30 font-black uppercase tracking-widest text-xs">Awaiting recurrence.</div>'}</div>`; lucide.createIcons();
            },

            school: async (target) => {
                const classes = await db.school.toArray(); const tasks = await db.tasks.toArray(); 
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-12"><section class="space-y-8"><h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest">Knowledge Module Streams</h3>${classes.map(c => `<div class="bg-indigo-600 text-white p-10 rounded-[3rem] shadow-xl overflow-hidden relative group">
                    <i data-lucide="graduation-cap" class="absolute -right-8 -bottom-8 w-32 h-32 opacity-10 group-hover:rotate-12 transition-transform"></i><div class="relative z-10"><h4 class="text-3xl font-black mb-1">${c.className}</h4><p class="text-xs font-bold text-white/60 tracking-widest uppercase">Prof. ${c.instructor || 'Unlisted'}</p><button onclick="logic.deleteData('school', ${c.id})" class="mt-8 text-[10px] uppercase font-black tracking-widest text-white/30 hover:text-white transition-opacity">Remove Course</button></div>
                </div>`).join('') || '<div class="py-10 text-slate-300 font-bold uppercase tracking-widest text-center text-xs">No registration.</div>'}</section><section class="space-y-6"><h3 class="text-[11px] font-black uppercase text-slate-400 tracking-widest">Pending Assignments</h3><div class="space-y-4">
                ${tasks.filter(t => t.classId).map(t => `<div class="p-6 bg-white border border-slate-100 rounded-[2rem] flex justify-between items-center group cursor-pointer hover:border-indigo-300 transition-all shadow-sm" onclick="logic.showDetails('tasks', ${t.id})">
                    <div class="flex items-center gap-4"><div class="w-3 h-3 rounded-full bg-indigo-500"></div><span class="text-sm font-black text-slate-700 ${t.status === 'done' ? 'line-through opacity-30' : ''}">${t.title}</span></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-300">${classes.find(c => c.id == t.classId)?.className.slice(0,10) || 'Active'}</span>
                </div>`).join('') || '<div class="py-10 text-slate-300 italic text-sm text-center">Load clear.</div>'}</div></section></div>`; lucide.createIcons();
            },

            extra: async (target) => {
                const extras = await db.extra.toArray();
                target.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8">${extras.map(e => `<div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex justify-between items-center group hover:border-indigo-200 transition-all"><span class="font-black text-slate-700 uppercase tracking-widest text-xs">${e.name}</span> <button onclick="logic.deleteData('extra', ${e.id})" class="text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all p-3"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join('') || '<div class="col-span-full py-20 text-center opacity-30 font-black uppercase tracking-widest text-xs">No extra modules.</div>'}</div>`;
                lucide.createIcons();
            }
        };

        const automation = {
            runner: async () => {
                if (!state.config.automation.autoCarryover) return; const today = new Date().toISOString().split('T')[0];
                const overdue = await db.tasks.where('dueDate').below(today).and(t => t.status !== 'done').toArray();
                if (overdue.length > 0) { for (let task of overdue) await db.tasks.update(task.id, { dueDate: today }); }
            }
        };

        /**
         * 7. CORE BUSINESS LOGIC (ALL URL/ICAL LOGIC PRESERVED)
         */
        const logic = {
            setTheme: (t) => { state.config.theme = t; logic.saveConfig(); logic.applyTheme(); router.load('settings'); },
            applyTheme: () => { const themes = ['light', 'dark', 'colorful', 'party']; themes.forEach(th => document.body.classList.remove(`theme-${th}`)); document.body.classList.add(`theme-${state.config.theme}`); },
            
            /* ADDED: TIMER DURATION SELECTOR */
            showTimerSettings: () => {
                const html = `
                    <div class="grid grid-cols-2 gap-5">
                        <button onclick="logic.setTimer(1500)" class="p-8 bg-indigo-50 border border-indigo-100 rounded-[2rem] font-black text-indigo-700 hover:bg-indigo-600 hover:text-white transition-all text-xl">25:00<span class="block text-[10px] mt-1 opacity-60 uppercase tracking-widest">Focus</span></button>
                        <button onclick="logic.setTimer(3000)" class="p-8 bg-indigo-50 border border-indigo-100 rounded-[2rem] font-black text-indigo-700 hover:bg-indigo-600 hover:text-white transition-all text-xl">50:00<span class="block text-[10px] mt-1 opacity-60 uppercase tracking-widest">Deep Work</span></button>
                        <button onclick="logic.setTimer(600)" class="p-8 bg-slate-50 border border-slate-100 rounded-[2rem] font-black text-slate-400 hover:bg-slate-900 hover:text-white transition-all text-xl">10:00<span class="block text-[10px] mt-1 opacity-60 uppercase tracking-widest">Quick Break</span></button>
                        <div class="p-8 bg-slate-50 border border-slate-100 rounded-[2.5rem] flex flex-col justify-center">
                           <input type="number" id="custom-min-input" class="w-full bg-transparent font-black text-3xl outline-none text-slate-800" placeholder="0">
                           <span class="text-[9px] font-black uppercase text-slate-300 tracking-[0.2em] mt-1">Manual Minutes</span>
                        </div>
                    </div>
                `;
                const action = `<button onclick="logic.setTimer(parseInt(document.getElementById('custom-min-input').value||0)*60)" class="px-10 py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 uppercase text-xs tracking-[0.1em]">Engage Timer</button>`;
                ui.modal.open("Temporal Adjustment", "Configure your perception of time", html, action);
            },
            setTimer: (secs) => { if(secs<=0)return; state.pomodoro.time = secs; state.pomodoro.totalTime = secs; ui.modal.close(); router.load('dashboard'); },

            openNewReminderModal: () => {
                const form = `<form onsubmit="logic.saveReminder(event)" class="space-y-6">
                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Notification Label</label><input name="title" required class="w-full p-5 border border-slate-100 rounded-3xl outline-none focus:ring-4 focus:ring-indigo-500/5 shadow-inner" placeholder="e.g. Health Sync"></div>
                    <div class="grid grid-cols-2 gap-5"><div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Daily Activation</label><input type="time" name="time" required class="w-full p-5 border border-slate-100 rounded-3xl"></div>
                    <div><label class="block text-[11px] font-black uppercase text-slate-400 mb-2 px-1 tracking-widest">Color Tag</label><input type="color" name="color" value="#6366f1" class="w-full h-[66px] p-2 border border-slate-100 rounded-3xl cursor-pointer"></div></div>
                    <button type="submit" class="w-full py-6 bg-slate-900 text-white font-black rounded-[2.5rem] shadow-2xl mt-4 uppercase tracking-widest text-xs">Confirm Rule</button></form>`;
                ui.modal.open("New Trigger", "Automated Daily Temporal Events", form);
            },
            saveReminder: async (e) => { e.preventDefault(); const data = Object.fromEntries(new FormData(e.target).entries()); data.dismissed = []; await db.reminders.add(data); ui.modal.close(); router.load('settings'); },
            refreshRemindersList: async () => {
                const container = document.getElementById('active-reminders-list'); if(!container) return;
                const rs = await db.reminders.toArray(); container.innerHTML = rs.length ? rs.map(r => `
                    <div class="p-8 bg-white border border-slate-100 rounded-[2.5rem] flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-6"><div class="w-1.5 h-1.5 rounded-full ring-[14px] ring-slate-50" style="background: ${r.color}"></div><div class="pl-4"><p class="font-black text-slate-800 text-xl leading-none tracking-tight">${r.title}</p><p class="text-[10px] font-black uppercase text-slate-400 mt-3 tracking-widest">Triggered daily @ ${r.time}</p></div></div>
                        <button onclick="logic.deleteData('reminders', ${r.id})" class="p-4 text-slate-200 hover:text-red-500 transition-all hover:bg-red-50 rounded-2xl"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>`).join('') : `<div class="p-10 border-2 border-dashed border-slate-50 rounded-[2.5rem] text-center text-[11px] font-black uppercase tracking-[0.4em] text-slate-200">No active manifest triggers</div>`;
                lucide.createIcons();
            },
            checkActiveReminders: async () => {
                const now = new Date(); const curTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                const dayStamp = now.toDateString(); const active = await db.reminders.toArray();
                active.forEach(r => { if (r.time === curTime && (!r.dismissed || !r.dismissed.includes(dayStamp))) logic.fireNotification(r); });
            },
            fireNotification: (r) => {
                if (document.getElementById(`toast-${r.id}`)) return;
                /* ALERT SOUND PLAYS ON REMINDERS */
                document.getElementById('timer-sound').play();
                const hub = document.getElementById('nexus-notification-hub');
                const toast = document.createElement('div'); toast.id = `toast-${r.id}`; toast.className = 'notification-toast shadow-2xl border-t-[10px]'; toast.style.borderColor = r.color;
                toast.innerHTML = `<div class="flex justify-between items-start mb-6"><div><span class="text-[10px] font-black uppercase text-slate-300 tracking-widest">Temporal Trigger</span><h4 class="font-black text-2xl text-slate-900 mt-2 tracking-tight">${r.title}</h4></div></div><button onclick="logic.dismissToastNotification(${id})" class="w-full py-4 text-xs font-black uppercase tracking-widest bg-slate-900 text-white rounded-2xl shadow-xl hover:bg-indigo-600 transition-all">Acknowledge</button>`;
                hub.appendChild(toast); lucide.createIcons();
            },
            dismissToastNotification: async (id) => {
                const el = document.getElementById(`toast-${id}`); if (el) { el.classList.add('dismissing'); setTimeout(() => el.remove(), 400); }
                const reminder = await db.reminders.get(id); if (reminder) { const logs = reminder.dismissed || []; const today = new Date().toDateString(); if(!logs.includes(today)) { logs.push(today); await db.reminders.update(id, { dismissed: logs }); } }
            },
            search: (val) => { state.searchQuery = val.toLowerCase(); if (state.currentView !== 'dashboard') router.load(state.currentView); },
            togglePomodoro: () => {
                if (state.pomodoro.active) { clearInterval(state.pomodoro.interval); state.pomodoro.active = false; } 
                else {
                    state.pomodoro.active = true;
                    state.pomodoro.interval = setInterval(() => {
                        state.pomodoro.time--;
                        if(state.pomodoro.time <= 0) {
                            logic.togglePomodoro();
                            /* ALERT SOUND ON TIMER END */
                            const audio = document.getElementById('timer-sound');
                            if(audio) audio.play();
                            alert("Focus manifestation complete!");
                        }
                        if(document.getElementById('pomo-timer')) {
                            document.getElementById('pomo-timer').innerText = `${Math.floor(state.pomodoro.time/60)}:${(state.pomodoro.time%60).toString().padStart(2, '0')}`;
                        }
                    }, 1000);
                } router.load('dashboard');
            },

            importIcs: async (input) => {
                const files = Array.from(input.files); if (!files.length) return;
                let count = 0;
                for (const file of files) {
                    const text = await file.text();
                    try {
                        const jcalData = ICAL.parse(text); const comp = new ICAL.Component(jcalData);
                        const vevents = comp.getAllSubcomponents('vevent');
                        for (const vevent of vevents) {
                            const event = new ICAL.Event(vevent);
                            await db.events.add({ title: event.summary, start: event.startDate.toJSDate().toISOString(), end: event.endDate.toJSDate().toISOString(), description: event.description || '', createdAt: Date.now() });
                            count++;
                        }
                    } catch (err) { console.error(err); }
                } alert(`Manifested ${count} new temporal blocks.`); router.load(state.currentView);
            },

            handleForm: async (e, key, id = null) => {
                e.preventDefault(); const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries());
                if (id) { await db[key].update(id, data); } else {
                    data.createdAt = Date.now(); if(key==='tasks')data.status='pending';
                    if(key==='projects'){data.progress=0; data.status='active';}
                    if(key==='habits'){data.streak=0; data.logs=[];}
                    await db[key].add(data);
                } ui.modal.close(); router.load(state.currentView);
            },
            showDetails: async (table, id) => {
                const item = await db[table].get(id); if (!item) return;
                let content = `<div class="space-y-10"><div class="grid grid-cols-2 gap-8 bg-slate-50/50 p-10 rounded-[2.5rem] border border-slate-100">
                    <div><p class="text-[10px] font-black uppercase text-slate-400 mb-1">Status</p><p class="text-xl font-black text-indigo-600 capitalize">${item.status||'Active'}</p></div>
                    ${item.priority?`<div><p class="text-[10px] font-black uppercase text-slate-400 mb-1">Impact</p><p class="text-xl font-black text-slate-800">${PRIORITY_LABELS[item.priority]}</p></div>`:''}
                    <div><p class="text-[10px] font-black uppercase text-slate-400 mb-1">Temporal Origin</p><p class="text-xl font-black text-slate-800">${new Date(item.createdAt).toLocaleDateString()}</p></div>
                </div><div class="space-y-4"><p class="text-[10px] font-black uppercase text-slate-400 pl-1">Detailed Logs</p><div class="bg-white p-8 rounded-[2.5rem] border border-slate-100 min-h-[160px] shadow-sm"><p class="text-slate-600 leading-relaxed font-medium">${item.description||'No additional manifest data.'}</p></div></div></div>`;
                const action = `<button onclick="ui.modal.renderForm('${table}', ${id})" class="px-10 py-4 bg-slate-900 font-black text-white text-xs uppercase tracking-widest rounded-2xl hover:bg-indigo-600 transition-all shadow-2xl">Modify Entry</button>`;
                ui.modal.open(item.title||item.name||item.className, "Analysis Overview", content, action);
            },
            toggleTask: async (id) => { const t = await db.tasks.get(id); await db.tasks.update(id, { status: t.status === 'done' ? 'pending' : 'done' }); router.load(state.currentView); },
            incrementHabit: async (id) => { const h = await db.habits.get(id); await db.habits.update(id, { streak: (parseInt(h.streak)||0) + 1 }); router.load(state.currentView); },
            resetHabit: async (id) => { if(confirm("Reset streak to zero?")) { await db.habits.update(id, { streak: 0 }); router.load(state.currentView); } },
            updateProjectProgress: async (id, inc) => { const p = await db.projects.get(id); const next = Math.min((parseInt(p.progress)||0) + inc, 100); await db.projects.update(id, { progress: next }); router.load(state.currentView); },
            deleteData: async (table, id) => { if(confirm("Purge Entry?")) { await db[table].delete(id); router.load(state.currentView); } },
            toggleFeature: (key) => { state.config.features[key] = !state.config.features[key]; logic.saveConfig(); ui.refreshNavigation(); router.load('settings'); },
            saveConfig: () => localStorage.setItem('app_config', JSON.stringify(state.config)),
            exportData: async () => { const res = {}; for (const t of db.tables) res[t.name] = await t.toArray(); const b = new Blob([JSON.stringify(res, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `nexus_dump_${Date.now()}.json`; a.click(); },
            factoryReset: async () => { if(confirm("Nuke Database? This cannot be undone.")) { await db.delete(); localStorage.clear(); window.location.reload(); } }
        };

        window.onload = ui.init;
    </script>
</body>
</html>
